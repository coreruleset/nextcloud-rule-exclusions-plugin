# ------------------------------------------------------------------------
# OWASP CRS Plugin
# Copyright (c) 2022-2025 CRS project. All rights reserved.
#
# The OWASP CRS plugins are distributed under
# Apache Software License (ASL) version 2
# Please see the enclosed LICENSE file for full details.
# ------------------------------------------------------------------------

# OWASP CRS Plugin
# Plugin name: nextcloud-rule-exclusions
# Plugin description:
# Rule ID block base: 9,508,000 - 9,508,999
# Plugin version: 1.3.1

# Documentation can be found here:
# https://github.com/coreruleset/nextcloud-rule-exclusions-plugin

# Disable workaround for iOS file upload by default
SecRule &TX:nextcloud-rule-exclusions-plugin_ios_workaround_enabled "@eq 0" "id:9508098,phase:1,pass,nolog,ctl:ruleRemoveById=9508119"

# Generic rule to disable plugin
SecRule TX:nextcloud-rule-exclusions-plugin_enabled "@eq 0" "id:9508099,phase:1,pass,nolog,ctl:ruleRemoveById=9508100-9508999"

# This plugin will resolve most false positives in Nextcloud, however due to some limitations this plugin can't
# fix all file upload related false positives out of the box. Please see the README.md file on how to resolve these false positives.
# See: https://github.com/coreruleset/nextcloud-rule-exclusions-plugin?tab=readme-ov-file#known-limitations

#
# [ Local CRS initialization ]
#
# We need to initialize some of the CRS variables also here because plugin setup runs before
# CRS initialization (this is a known limitation of the current plugin architecture). Must be
# kept in sync with CRS default setting.


# Copy of CRS rule 901160.
SecRule &TX:allowed_methods "@eq 0" \
    "id:9508100,\
    phase:1,\
    pass,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    setvar:'tx.allowed_methods=GET HEAD POST OPTIONS'"


# Copy of CRS rule 901162.
SecRule &TX:allowed_request_content_type "@eq 0" \
    "id:9508101,\
    phase:1,\
    pass,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    setvar:'tx.allowed_request_content_type=|application/x-www-form-urlencoded| |multipart/form-data| |text/xml| |application/xml| |application/soap+xml| |application/json|'"

#
# [ File Manager - File Downloads/Uploads ]
#

# Allow REPORT requests without Content-Type header (at least the iOS app does this)
SecRule REQUEST_METHOD "@streq REPORT" \
    "id:9508110,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    chain"
    SecRule REQUEST_FILENAME "@contains /remote.php/dav/files/" \
        "t:none,\
        ctl:ruleRemoveById=920340,\
        ctl:ruleRemoveById=920341"

# Moving chunked file uploads to the user's files directory
SecRule REQUEST_FILENAME "@rx /remote\.php/dav/uploads/[^/]+/[^/]+/\.file$" \
    "id:9508111,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    chain"
    SecRule REQUEST_METHOD "@streq MOVE" \
        "t:none,\
        setvar:'tx.allowed_request_content_type=%{tx.allowed_request_content_type} |application/octet-stream|'"

# Fix FP with response rules when downloading files from the server.
# Downloaded files could contain anything.
# Matches:
#   /remote.php/dav/files/username/path/to/example
#   /remote.php/webdav/path/to/file
#   /public.php/webdav/path/to/file
#   /public.php/dav/files/<share-id>/path/to/file
SecRule REQUEST_FILENAME "@rx /(?:public|remote)\.php/(?:dav/files|dav/webdav|webdav)/" \
    "id:9508112,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    chain"
    SecRule REQUEST_METHOD "@streq GET" \
        "t:none,\
        ctl:ruleRemoveById=951000-951999,\
        ctl:ruleRemoveById=953100-953130,\
        ctl:ruleRemoveById=954100,\
        ctl:ruleRemoveById=954110,\
        ctl:ruleRemoveById=954120,\
        ctl:ruleRemoveById=955100,\
        ctl:ruleRemoveById=955110,\
        ctl:ruleRemoveById=955300,\
        ctl:ruleRemoveById=955350"

# Fix false positives for filenames when uploading/downloading files
# Matches:
#   /remote.php/dav/files/username/path/to/example
#   /remote.php/webdav/path/to/file
#   /public.php/webdav/path/to/file
#   /public.php/dav/files/<share-id>/path/to/file
SecRule REQUEST_FILENAME "@rx /(?:public|remote)\.php/(?:dav/files|dav/webdav|webdav)/" \
    "id:9508113,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveById=920440,\
    ctl:ruleRemoveTargetById=930120;REQUEST_FILENAME,\
    ctl:ruleRemoveTargetById=930130;REQUEST_FILENAME,\
    ctl:ruleRemoveTargetById=933150;REQUEST_FILENAME,\
    ctl:ruleRemoveTargetById=933210;REQUEST_FILENAME,\
    ctl:ruleRemoveTargetById=942120;REQUEST_FILENAME"

# Uploading files to Nextcloud. Multiple endpoints are used for file uploads, all of
# them are matched here for simplicity.
#
# The content type of an uploaded file can be anything, sometimes a content type header isn't even set at all.
#
# matches:
#   /remote.php/dav/uploads/<username>/<random>/<random>
#   /remote.php/dav/bulk
#   /remote.php/dav/files/username/path/to/example
#   /remote.php/dav/webdav
#   /remote.php/webdav/path/to/file
#   /public.php/webdav/path/to/file
#   /public.php/dav/files/<share-id>/path/to/file
#
# NOTE: /remote.php/dav/webdav is no longer used for file uploads via
# the web GUI as of NC 28
# Please modify this rule with care as this rule allows all content types, if this rule is too loose then it may cause a bypass!
SecRule REQUEST_FILENAME "@rx /(?:remote\.php/(?:dav/bulk$|dav/files/|dav/uploads/(?:[^/]+/?){3}|webdav/|dav/webdav)|public\.php/(?:dav/files|webdav/))" \
    "id:9508114,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    chain"
    SecRule REQUEST_METHOD "@pm POST PUT" \
        "t:none,\
        ctl:ruleRemoveById=920340,\
        ctl:ruleRemoveById=920341,\
        ctl:ruleRemoveById=920420,\
        ctl:ruleRemoveById=921422,\
        ctl:ruleRemoveTargetById=920260;REQUEST_BODY,\
        ctl:ruleRemoveTargetById=920272;REQUEST_BODY,\
        ctl:ruleRemoveTargetById=920273;REQUEST_BODY,\
        ctl:ruleRemoveTargetById=921110;REQUEST_BODY,\
        ctl:ruleRemoveTargetById=931110;REQUEST_BODY,\
        ctl:ruleRemoveTargetById=944100;REQUEST_BODY,\
        ctl:ruleRemoveTargetById=944110;REQUEST_BODY,\
        ctl:ruleRemoveTargetById=944120;REQUEST_BODY,\
        ctl:ruleRemoveTargetById=944130;REQUEST_BODY,\
        ctl:ruleRemoveTargetById=944200;REQUEST_BODY,\
        ctl:ruleRemoveTargetById=944210;REQUEST_BODY,\
        ctl:ruleRemoveTargetById=944240;REQUEST_BODY,\
        ctl:ruleRemoveTargetById=944250;REQUEST_BODY,\
        ctl:ruleRemoveTargetById=944260;REQUEST_BODY"

# Syncing files with Nextcloud desktop app
# Matches:
# - /remote.php/dav/files/username/
# - /remote.php/dav/files/username/path/to/example
SecRule REQUEST_FILENAME "@contains /remote.php/dav/files/" \
    "id:9508116,\
    phase:3,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    chain"
    SecRule RESPONSE_STATUS "@rx ^50[023]$" \
        "t:none,\
        ctl:ruleRemoveById=950100"

# Nextcloud 26 and older uses the `if` header when uploading files
SecRule REQUEST_FILENAME "@rx /remote\.php/dav/uploads/[^/]+/[0-9]+/\.file$" \
    "id:9508117,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    chain"
    SecRule &REQUEST_HEADERS:if "@eq 1" \
        "t:none,\
        ctl:ruleRemoveById=920450"

# WebDAV client searching for files.
# The / at the end is sometimes missing.
SecRule REQUEST_FILENAME "@rx /remote\.php/dav/?$" \
    "id:9508118,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    chain"
    SecRule REQUEST_METHOD "@streq SEARCH" \
        "t:none,\
        ctl:ruleRemoveTargetById=942430;XML:/*,\
        ctl:ruleRemoveTargetById=942431;XML:/*,\
        ctl:ruleRemoveTargetById=942432;XML:/*"

# The Nextcloud iOS app sets an incorrect content type when uploading binary data. It uses either
# application/xml or application/x-www-form-urlencoded content type instead of application/octet-stream.
# This data isn't parseable by ModSecurity, so this rule essentially disables all rules for the request body.
# There's a real risk this rule could introduce a bypass, so it's disabled by default and should only be enabled
# if really needed. This rule is just a workaround, this should be fixed within the iOS app.
# See:
#   - https://github.com/nextcloud/ios/issues/1942
#   - https://coreruleset.org/20210630/cve-2021-35368-crs-request-body-bypass/
#   - https://nvd.nist.gov/vuln/detail/CVE-2021-35368
SecRule REQUEST_FILENAME "@rx /remote\.php/dav/(?:files/|uploads/[^/]+/[^/]+(?:/[^/]+)?$)" \
    "id:9508119,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    chain"
    SecRule REQUEST_HEADERS:User-Agent "@contains Nextcloud-iOS" \
        "t:none,\
        chain"
        SecRule REQUEST_HEADERS:Content-Type "@rx ^application/(?:x-www-form-urlencoded|xml)$" \
            "t:none,\
            chain"
            SecRule REQUEST_METHOD "@pm POST PUT" \
                "t:none,\
                ctl:ruleRemoveById=200002,\
                ctl:ruleRemoveById=200007,\
                ctl:ruleRemoveById=920240,\
                ctl:ruleRemoveById=920250,\
                ctl:ruleRemoveTargetById=920540;ARGS,\
                ctl:ruleRemoveTargetById=920540;ARGS_NAMES,\
                ctl:ruleRemoveTargetById=921110;REQUEST_BODY,\
                ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS,\
                ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS_NAMES"

#
# [ File Manager - Web GUI ]
#

# File manager: Restoring a file to a previous / newer version
SecRule REQUEST_FILENAME "@rx /remote\.php/dav/versions/[^/]+/versions/[0-9]+/$" \
    "id:9508130,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=920272;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=920273;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=921110;REQUEST_BODY"

# File manager: system tags
SecRule REQUEST_FILENAME "@rx /remote\.php/dav/systemtags(?:-relations/files/[0-9]+|-assigned/image)?/$" \
    "id:9508131,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=920272;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=920273;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=921110;REQUEST_BODY"

# Posting a comment on a file
# The content of comments could be anything
SecRule REQUEST_FILENAME "@rx /remote\.php/dav/comments/files(?:/[0-9]+)+$" \
    "id:9508132,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=920272;ARGS:creationDateTime,\
    ctl:ruleRemoveTargetById=920273;ARGS:creationDateTime,\
    ctl:ruleRemoveTargetById=942432;ARGS:creationDateTime,\
    ctl:ruleRemoveTargetById=920272;ARGS:json.creationDateTime,\
    ctl:ruleRemoveTargetById=920273;ARGS:json.creationDateTime,\
    ctl:ruleRemoveTargetById=942432;ARGS:json.creationDateTime,\
    ctl:ruleRemoveTargetById=920272;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=920273;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=921110;REQUEST_BODY,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:message,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.message"

# Viewing files within the trashbin
SecRule REQUEST_FILENAME "@rx /remote\.php/dav/trashbin/[^/]+/trash/" \
    "id:9508133,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=920272;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=920273;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=921110;REQUEST_BODY"

# Entering a password for a password protected share
# Some Nextcloud versions have inconsistent case sensitivity
SecRule REQUEST_FILENAME "@rx (?i)/s/[^/]+/authenticate/showshare$" \
    "id:9508134,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:password,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1'"

# Sharing a file/folder
# Fix FP when creating a share with a password
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9.]+\.php/apps/files_sharing/api/v[0-9]/shares(?:/[0-9]+)?$" \
    "id:9508135,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetById=930120;ARGS:json.path,\
    ctl:ruleRemoveTargetById=930120;ARGS:path,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:password,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.password,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1'"

# Creating a password protected file upload request and emailing the recipient
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9.]+\.php/apps/files_sharing/api/v[0-9]+/shares/[0-9]+/send-email$" \
    "id:9508137,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.password,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:password"

# Viewing/Editing comments on a file
# The content of comments could be anything
SecRule REQUEST_FILENAME "@rx /remote\.php/dav/comments/files(?:/[0-9]+)+$" \
    "id:9508138,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=941160;XML:/*,\
    ctl:ruleRemoveTargetById=941160;XML"

#
# [ Searchengine ]
#

# Nextcloud uses a search field for filename or content queries.
SecRule REQUEST_FILENAME "@contains /index.php/core/search" \
    "id:9508170,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=941000-942999;ARGS:query,\
    ctl:ruleRemoveTargetById=932000-932999;ARGS:query,\
    ctl:ruleRemoveTargetByTag=attack-injection-php;ARGS:query"

# Searching for files, folders, contacts, tasks, emails, etc.
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9.]+\.php/search/providers(?:/[^/]+/search)?$" \
    "id:9508171,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=920230;ARGS:from,\
    ctl:ruleRemoveTargetById=932190;ARGS:from,\
    ctl:ruleRemoveTargetById=932200;ARGS:from,\
    ctl:ruleRemoveTargetById=942200;ARGS:from,\
    ctl:ruleRemoveTargetById=942210;ARGS:from,\
    ctl:ruleRemoveTargetById=942430;ARGS:from,\
    ctl:ruleRemoveTargetById=942440;ARGS:from"

#
# [ DAV ]
#

# Nextcloud makes very heavy use of WebDAV request methods, this
# rule allows all of the required request methods for Nextcloud globally.
# Only allowing the exact request methods for the exact endpoints will result
# in a huge explosion of the number of rule exclusions and time spent maintaining these rules.
# NOTE: sometimes DAV clients will make requests to `/remote.php/dav` with no trailing slash
SecRule REQUEST_FILENAME "@rx /(?:remote\.php|index\.php/|public\.php/|apps/|ocs/|\.well-known/|settings/)" \
    "id:9508190,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT PATCH CHECKOUT COPY DELETE LOCK MERGE MKACTIVITY MKCALENDAR MKCOL MOVE PROPFIND PROPPATCH SEARCH UNLOCK REPORT TRACE jsonp'"

# Allow CalDav/CarDav clients to scan for CalDav CarDav path
# Thunderbird uses PUT method when configured as a CalDav/CardDav
SecRule REQUEST_FILENAME "@streq /" \
    "id:9508191,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=921110;REQUEST_BODY,\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT PROPFIND'"

# Dav clients frequently set a content type header with an empty request body on multiple endpoints,
# resulting in false positives with rule 200002. This rule covers all of the endpoints
# that this false positives happen on for simplicity.
# Matches:
#   /remote.php/dav/files/
#   /public.php/dav/files/
#   /remote.php/dav/addressbook/users/
#   /remote.php/dav/calendars/
SecRule REQUEST_FILENAME "@rx /(?:remote|public)\.php/dav/" \
    "id:9508192,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    chain"
    SecRule REQUEST_HEADERS:Content-Type "@rx ^(?:text/plain|text/xml|application/xml)" \
        "t:none,\
        chain"
        SecRule REQUEST_BODY_LENGTH "@eq 0" \
            "t:none,\
            ctl:ruleRemoveById=200002"

# When Dav clients use the text/plain content type it's always XML data
SecRule REQUEST_FILENAME "@rx /(?:remote|public)\.php" \
    "id:9508193,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    chain"
    SecRule REQUEST_HEADERS:Content-Type "@beginsWith text/plain" \
        "t:none,\
        ctl:requestBodyProcessor=XML,\
        setvar:'tx.allowed_request_content_type=%{tx.allowed_request_content_type} |text/plain|'"

#
# [ Preview and Thumbnails ]
#

# Preview
SecRule REQUEST_FILENAME "@contains /index.php/core/preview.png" \
    "id:9508210,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=932150;ARGS:file"

# Filepreview for trashbin
SecRule REQUEST_FILENAME "@contains /index.php/apps/files_trashbin/ajax/preview.php" \
    "id:9508211,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=932150;ARGS:file,\
    ctl:ruleRemoveTargetById=942190;ARGS:file"

#
# [ Ownnote ]
#

SecRule REQUEST_FILENAME "@contains /index.php/apps/ownnote/" \
    "id:9508300,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveById=941150"

#
# [ Text Editor ]
#

# This file can save anything, and it's name could be lots of things.
SecRule REQUEST_FILENAME "@contains /index.php/apps/files_texteditor/" \
    "id:9508310,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=920370-920390;ARGS:filecontents,\
    ctl:ruleRemoveTargetById=920370-920390;ARGS_COMBINED_SIZE,\
    ctl:ruleRemoveTargetById=921110-921160;ARGS:filecontents,\
    ctl:ruleRemoveTargetById=932150;ARGS:filename,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:filecontents"

# Handle false positives for token related false positives (Used for session
# tracking, multi-user editing, guest edits, etc)
# There are either way too many parameters that are used for specific endpoints or the
# parameters just keep on changing. This rule disables rules for all ARGS for the
# text editor app instead of trying to disable rules for exact parameters on the exact
# endpoints they are used on.
# Matches:
#   /apps/text/session/sync
#   /apps/text/session/close
#   /apps/text/session/push
#   /apps/text/session/123/sync
#   /apps/text/session/123/close
#   /apps/text/session/123/push
#   /apps/text/public/session/sync
#   /apps/text/public/session/close
#   /apps/text/public/session/push
#   /apps/text/public/session/123/sync
#   /apps/text/public/session/123/close
#   /apps/text/public/session/123/push
#   /apps/text/attachments
SecRule REQUEST_FILENAME "@rx /apps/text/(?:public/)?(?:session/(?:[0-9]+/)?(?:sync|close|push|save)|attachments)$" \
    "id:9508311,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=920273;ARGS,\
    ctl:ruleRemoveTargetById=932236;ARGS,\
    ctl:ruleRemoveTargetById=932250;ARGS,\
    ctl:ruleRemoveTargetById=941100;ARGS,\
    ctl:ruleRemoveTargetById=942120;ARGS,\
    ctl:ruleRemoveTargetById=942210;ARGS,\
    ctl:ruleRemoveTargetById=942390;ARGS,\
    ctl:ruleRemoveTargetById=942432;ARGS,\
    ctl:ruleRemoveTargetById=942450;ARGS,\
    ctl:ruleRemoveTargetById=920272;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=920273;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=921110;REQUEST_BODY"

# Autosaving/syncing a text document, content could be anything
# Manually saving a text document
# As of Nextcloud 28, the document ID is included in the URL path
SecRule REQUEST_FILENAME "@rx /apps/text/(?:public/)?session(?:/[0-9]+)?/(?:sync|save)$" \
    "id:9508313,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:autosaveContent,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.autosaveContent"

# Text app content can be anything
# We disable CRS for all ARGS since the paramater keeps on changing and can't be predicted
# This false positive only happens on Nextcloud 27 and earlier
SecRule REQUEST_FILENAME "@rx /apps/text/(?:public/)?session/push$" \
    "id:9508314,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS"

#
# [ Address Book ]
#

# Allow the data type 'text/vcard'
SecRule REQUEST_FILENAME "@contains /remote.php/dav/addressbooks/" \
    "id:9508320,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    setvar:'tx.allowed_request_content_type=%{tx.allowed_request_content_type} |text/vcard|'"

# Loading Contact profile pictures
SecRule REQUEST_FILENAME "@rx /remote\.php/dav/addressbooks/users/(?:[^/]+/){2}[0-9]+$" \
    "id:9508323,\
    phase:3,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    chain"
    SecRule RESPONSE_STATUS "@streq 501" \
        "t:none,\
        ctl:ruleRemoveById=950100"

# Syncing contacts via a dav client
SecRule REQUEST_FILENAME "@rx /remote\.php/dav/addressbooks/users/(?:[^/]+/){1,2}\.vcf$" \
    "id:9508324,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=921110;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=942430;XML:/*,\
    ctl:ruleRemoveTargetById=942431;XML:/*,\
    ctl:ruleRemoveTargetById=942432;XML:/*,\
    ctl:ruleRemoveTargetById=942440;XML:/*"

#
# [ Calendar ]
#

# Allow the data type 'text/calendar'
SecRule REQUEST_FILENAME "@rx /remote\.php/(?:cal)?dav/calendars/" \
    "id:9508330,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    setvar:'tx.allowed_request_content_type=%{tx.allowed_request_content_type} |text/calendar|'"

# Syncing calendars
SecRule REQUEST_FILENAME "@rx /remote\.php/dav/calendars/(?:[^/]+/){2}[^/]+\.ics$" \
    "id:9508333,\
    phase:3,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    chain"
    SecRule RESPONSE_STATUS "@streq 500" \
        "t:none,\
        ctl:ruleRemoveById=950100"

# Creating/Editing/deleting an existing calendar appointments
# Calendar description can be anything
SecRule REQUEST_FILENAME "@rx /apps/calendar/v[0-9.]+/appointment_configs(?:/[0-9]+)?$" \
    "id:9508334,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:description,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.description"

# Signing into caldav via iPhone
# Creating new calendar groups in web GUI
SecRule REQUEST_FILENAME "@rx /remote\.php/dav/calendars/[^/]+/[^/]+/?$" \
    "id:9508336,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=920272;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=920273;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=942430;XML,\
    ctl:ruleRemoveTargetById=942431;XML,\
    ctl:ruleRemoveTargetById=942432;XML,\
    ctl:ruleRemoveTargetById=942440;XML,\
    ctl:ruleRemoveTargetById=942430;XML:/*,\
    ctl:ruleRemoveTargetById=942431;XML:/*,\
    ctl:ruleRemoveTargetById=942432;XML:/*,\
    ctl:ruleRemoveTargetById=942440;XML:/*"

# Editing calendar tasks notes
SecRule REQUEST_FILENAME "@rx /remote\.php/dav/calendars/(?:[^/]+/){2}[^/]+\.ics$" \
    "id:9508338,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveById=920530"

#
# [ Notes ]
#

# We want to allow a lot of things as the user is
# allowed to note on anything.
SecRule REQUEST_FILENAME "@contains /index.php/apps/notes/" \
    "id:9508350,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveByTag=attack-injection-php"

#
# [ Bookmarks ]
#

# Allow urls in data.
SecRule REQUEST_FILENAME "@contains /index.php/apps/bookmarks/" \
    "id:9508370,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveById=931130"

#
# [ Login forms and Logout ]
#
# This removes checks on the 'password' and related fields:

# User login password.
# Asking an admin to reauthenticate when performing administrative changes
# Asking an user to reauthenticate when making changes to account settings
SecRule REQUEST_FILENAME "@rx /login(?:/confirm)?$" \
    "id:9508400,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=920272;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=920273;REQUEST_BODY,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:password,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.password"

# When logging in via FIDO2
SecRule REQUEST_FILENAME "@endsWith /login/webauthn/finish" \
    "id:9508402,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=920273;ARGS:data,\
    ctl:ruleRemoveTargetById=932236;ARGS:data,\
    ctl:ruleRemoveTargetById=920273;ARGS:json.data,\
    ctl:ruleRemoveTargetById=932236;ARGS:json.data,\
    ctl:ruleRemoveTargetById=920272;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=920273;REQUEST_BODY,\
    ctl:ruleRemoveTargetByTag=attack-sqli;ARGS:data,\
    ctl:ruleRemoveTargetByTag=attack-sqli;ARGS:json.data"

# Logging in via desktop app
SecRule REQUEST_FILENAME "@rx /login/v[0-9.]+/grant$" \
    "id:9508403,\
    phase:2,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=932236;ARGS:stateToken,\
    ctl:ruleRemoveTargetById=942450;ARGS:stateToken"

# Reset password.
SecRule REQUEST_FILENAME "@endsWith /login" \
    "id:9508410,\
    phase:2,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    chain"
    SecRule ARGS:action "@streq resetpass" \
        "t:none,\
        chain"
        SecRule &ARGS:action "@eq 1" \
            "t:none,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:pass1,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:pass1-text,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:pass2"

# Password reset used in newer versions of Nextcloud
SecRule REQUEST_FILENAME "@rx /lostpassword/set/[^/]+/[^/]+$" \
    "id:9508411,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:password,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.password"

# Logging in with webauthn
# HTTP 500 error code may sometimes be returned when authenticating
SecRule REQUEST_FILENAME "@endsWith /login/webauthn/finish" \
    "id:9508421,\
    phase:3,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    chain"
    SecRule RESPONSE_STATUS "@streq 500" \
        "t:none,\
        ctl:ruleRemoveById=950100"

# Change Password and Setting up a new user/password
SecRule REQUEST_FILENAME "@endsWith /settings/users" \
    "id:9508500,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:newuserpassword,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:password"

# Nextcloud administrator setting/changing a user's password
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9.]+\.php/cloud/users(?:/[^/]+)?$" \
    "id:9508501,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:password,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:value,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.password,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.value"

# Being redirected to login page via desktop app
SecRule REQUEST_FILENAME "@rx /login(?:/selectchallenge|/challenge/[^/]+)?$" \
    "id:9508502,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=920230;ARGS:redirect_url,\
    ctl:ruleRemoveTargetById=932200;ARGS:redirect_url,\
    ctl:ruleRemoveTargetById=932190;ARGS:redirect_url,\
    ctl:ruleRemoveTargetById=942431;ARGS:redirect_url,\
    ctl:ruleRemoveTargetById=942432;ARGS:redirect_url"


#
# [ General rule exclusions ]
#

# Fix Nextcloud Cookie FPs
# Operator @unconditionalMatch is used instead of a SecAction because of a bug
# in ModSecurity v3 which prevents SecActions to be removed using ctl action.
# Fix FP with requesttoken used for various requests in Nextcloud.
# Fix FP with timezone
SecRule REQUEST_FILENAME "@unconditionalMatch" \
    "id:9508510,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=920273;ARGS:requesttoken,\
    ctl:ruleRemoveTargetById=932236;ARGS:requesttoken,\
    ctl:ruleRemoveTargetById=941100;ARGS:requesttoken,\
    ctl:ruleRemoveTargetById=941120;ARGS:requesttoken,\
    ctl:ruleRemoveTargetById=942390;ARGS:requesttoken,\
    ctl:ruleRemoveTargetById=942432;ARGS:requesttoken,\
    ctl:ruleRemoveTargetById=942450;ARGS:requesttoken,\
    ctl:ruleRemoveTargetById=920273;ARGS:timezone,\
    ctl:ruleRemoveTargetById=932236;REQUEST_COOKIES:nc_session_id,\
    ctl:ruleRemoveTargetById=942450;REQUEST_COOKIES:nc_session_id,\
    ctl:ruleRemoveTargetById=932236;REQUEST_COOKIES:nc_token,\
    ctl:ruleRemoveTargetById=942450;REQUEST_COOKIES:nc_token,\
    ctl:ruleRemoveTargetById=932236;REQUEST_COOKIES:oc_sessionPassphrase,\
    ctl:ruleRemoveTargetById=942210;REQUEST_COOKIES:oc_sessionPassphrase,\
    ctl:ruleRemoveTargetById=942450;REQUEST_COOKIES:oc_sessionPassphrase"

# Fix false positives with static files
SecRule REQUEST_FILENAME "@rx (?i)\.(?:avif|bmp|brotli|bvr|css|eot|gif|gz|ico|jpeg|jpg|map|m?js|mp[34]|otf|png|svg|swf|ts|ttf|txt|wav|webp|woff2?)$" \
    "id:9508511,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=932236;ARGS:v"

# Setting SecRequestBodyNoFilesLimit to a very high value results in all requests
# being interpreted as exceeding the configured limit due to a bug in libModSecurity3.
# This rule works around the bug for some common requests. It's possible this bug happens in other areas
# but this has only been tested based on the recommendations in the plugin's readme.
# See: https://github.com/owasp-modsecurity/ModSecurity/issues/3356
SecRule REQUEST_FILENAME "@contains /remote.php/dav/files" \
    "id:9508512,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    chain"
    SecRule REQUEST_METHOD "@pm MKCOL DELETE" \
        "t:none,\
        chain"
        SecRule REQUEST_HEADERS:Content-Type "@streq application/x-www-form-urlencoded" \
            "t:none,\
            chain"
            SecRule REQUEST_HEADERS:content-length "@eq 0" \
                "t:none,\
                ctl:ruleRemoveById=200002"

# Websocket connection to Files HBP (Notify_Push) don't have a user-agent.
# Sometimes there will be a double slash after /push/
SecRule REQUEST_FILENAME "@rx /push//?ws$" \
    "id:9508513,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveById=920320"

#
# [ Nextcloud Setup ]
#

# Setting up a fresh Nextcloud Server
# Nextcloud will accept any URL endpoint during setup
SecRule ARGS:install "@streq true" \
    "id:9508520,\
    phase:2,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    chain"
    SecRule ARGS:dbtype "@rx ^(?:mysql|pgsql|sqlite)$" \
        "t:none,\
        ctl:ruleRemoveTargetById=932236;ARGS:dbtype,\
        ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:adminpass,\
        ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:dbpass,\
        ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:dbpass-clone"

#
# [ Nextcloud Office - Connector ]
#

# Creating/modifying documents in Nextcloud Office
# Renaming a document within Nextcloud Office
# application/octet-stream is raw binary data, ModSecurity can't inspect it as there's no parser available for it
SecRule REQUEST_FILENAME "@rx /index\.php/apps/richdocuments/wopi/files/[^/]+(?:/contents)?$" \
    "id:9508530,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=932236;ARGS:access_token,\
    ctl:ruleRemoveTargetById=942450;ARGS:access_token,\
    ctl:ruleRemoveTargetById=920272;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=920273;REQUEST_BODY,\
    setvar:'tx.allowed_request_content_type=%{tx.allowed_request_content_type} |application/octet-stream|'"

# Generating nextcloud office document previews
SecRule REQUEST_FILENAME "@endsWith /lool/convert-to/png" \
    "id:9508531,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=920120;FILES_NAMES,\
    ctl:ruleRemoveTargetById=920121;FILES_NAMES,\
    ctl:ruleRemoveTargetById=920272;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=920273;REQUEST_BODY"

# Copying and pasting from clipboard within Nextcloud Office
SecRule REQUEST_FILENAME "@endsWith /cool/clipboard" \
    "id:9508532,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=921110;REQUEST_BODY"

#
# [ Nextcloud Office - Built in Code Server ]
#

# Checking document state with built in collabora CODE Server
# Text/plain content is actually urlencoded data
# Parameter name keeps on changing so rules are disabled for all ARGS/ARGS_NAMES
SecRule REQUEST_FILENAME "@endsWith /apps/richdocumentscode/proxy.php" \
    "id:9508540,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    chain"
    SecRule REQUEST_HEADERS:Content-Type "@beginsWith text/plain" \
        "t:none,\
        ctl:requestBodyProcessor=URLENCODED,\
        ctl:ruleRemoveTargetById=920273;ARGS,\
        ctl:ruleRemoveTargetById=932240;ARGS,\
        ctl:ruleRemoveTargetById=942200;ARGS,\
        ctl:ruleRemoveTargetById=942330;ARGS,\
        ctl:ruleRemoveTargetById=942430;ARGS,\
        ctl:ruleRemoveTargetById=942431;ARGS,\
        ctl:ruleRemoveTargetById=942432;ARGS,\
        ctl:ruleRemoveTargetById=942450;ARGS,\
        ctl:ruleRemoveTargetById=920273;ARGS_NAMES,\
        ctl:ruleRemoveTargetById=921150;ARGS_NAMES,\
        ctl:ruleRemoveTargetById=942200;ARGS_NAMES,\
        ctl:ruleRemoveTargetById=942330;ARGS_NAMES,\
        ctl:ruleRemoveTargetById=942340;ARGS_NAMES,\
        ctl:ruleRemoveTargetById=942370;ARGS_NAMES,\
        ctl:ruleRemoveTargetById=942430;ARGS_NAMES,\
        ctl:ruleRemoveTargetById=942431;ARGS_NAMES,\
        ctl:ruleRemoveTargetById=942432;ARGS_NAMES,\
        ctl:ruleRemoveTargetById=942450;ARGS_NAMES,\
        setvar:'tx.allowed_request_content_type=%{tx.allowed_request_content_type} |text/plain|'"

# Making changes to a document using built in collabora CODE Server
SecRule REQUEST_FILENAME "@endsWith /apps/richdocumentscode/proxy.php" \
    "id:9508541,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=931130;ARGS:buy_product,\
    ctl:ruleRemoveTargetById=920272;ARGS:css_variables,\
    ctl:ruleRemoveTargetById=920273;ARGS:css_variables,\
    ctl:ruleRemoveTargetById=942422;ARGS:css_variables,\
    ctl:ruleRemoveTargetById=942430;ARGS:css_variables,\
    ctl:ruleRemoveTargetById=942431;ARGS:css_variables,\
    ctl:ruleRemoveTargetById=942432;ARGS:css_variables,\
    ctl:ruleRemoveTargetById=942440;ARGS:css_variables,\
    ctl:ruleRemoveTargetById=942460;ARGS:css_variables,\
    ctl:ruleRemoveTargetById=932236;ARGS:req,\
    ctl:ruleRemoveTargetById=932190;ARGS:req,\
    ctl:ruleRemoveTargetById=942431;ARGS:req,\
    ctl:ruleRemoveTargetById=942432;ARGS:req,\
    ctl:ruleRemoveTargetById=942430;ARGS:ui_defaults,\
    ctl:ruleRemoveTargetById=942431;ARGS:ui_defaults,\
    ctl:ruleRemoveTargetById=942432;ARGS:ui_defaults,\
    ctl:ruleRemoveTargetById=920272;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=920273;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=921110;REQUEST_BODY"

#
# [ Nextcloud Office - Dedicated Collabora Server ]
#

# Checking document state with dedicated Collabora Server
SecRule REQUEST_FILENAME "@rx /browser/[^/]+/cool\.html$" \
    "id:9508550,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    chain"
    SecRule REQUEST_HEADERS:Content-Type "@beginsWith text/plain" \
        "t:none,\
        ctl:requestBodyProcessor=XML,\
        setvar:'tx.allowed_request_content_type=%{tx.allowed_request_content_type} |text/plain|'"

# Making changes to a document using dedicated Collabora Server
SecRule REQUEST_FILENAME "@rx /browser/[^/]+/cool\.html$" \
    "id:9508551,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=931130;ARGS:buy_product,\
    ctl:ruleRemoveTargetById=932236;ARGS:access_token,\
    ctl:ruleRemoveTargetById=942450;ARGS:access_token,\
    ctl:ruleRemoveTargetById=920272;ARGS:css_variables,\
    ctl:ruleRemoveTargetById=920273;ARGS:css_variables,\
    ctl:ruleRemoveTargetById=942422;ARGS:css_variables,\
    ctl:ruleRemoveTargetById=942430;ARGS:css_variables,\
    ctl:ruleRemoveTargetById=942431;ARGS:css_variables,\
    ctl:ruleRemoveTargetById=942432;ARGS:css_variables,\
    ctl:ruleRemoveTargetById=942440;ARGS:css_variables,\
    ctl:ruleRemoveTargetById=942460;ARGS:css_variables,\
    ctl:ruleRemoveTargetById=932236;ARGS:req,\
    ctl:ruleRemoveTargetById=932190;ARGS:req,\
    ctl:ruleRemoveTargetById=942431;ARGS:req,\
    ctl:ruleRemoveTargetById=942432;ARGS:req,\
    ctl:ruleRemoveTargetById=942430;ARGS:ui_defaults,\
    ctl:ruleRemoveTargetById=942431;ARGS:ui_defaults,\
    ctl:ruleRemoveTargetById=942432;ARGS:ui_defaults,\
    ctl:ruleRemoveTargetById=920272;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=920273;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=921110;REQUEST_BODY"

#
# [ Personal Settings ]
#

# Personal Settings --> Security --> Passwordless Authentication
# Registering webauthn devices
SecRule REQUEST_FILENAME "@endsWith /settings/api/personal/webauthn/registration" \
    "id:9508609,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=920273;ARGS:data,\
    ctl:ruleRemoveTargetById=932236;ARGS:data,\
    ctl:ruleRemoveTargetById=920273;ARGS:json.data,\
    ctl:ruleRemoveTargetById=932236;ARGS:json.data,\
    ctl:ruleRemoveTargetById=920273;REQUEST_BODY,\
    ctl:ruleRemoveTargetByTag=attack-sqli;ARGS:data,\
    ctl:ruleRemoveTargetByTag=attack-sqli;ARGS:json.data"

# Personal Settings --> Security --> Password
# When a user is changing their password under
SecRule REQUEST_FILENAME "@endsWith /settings/personal/changepassword" \
    "id:9508610,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:oldpassword,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:newpassword,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.oldpassword,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.newpassword"

# Personal Settings --> Availability --> Availability
# Adjusting availability hours
SecRule REQUEST_FILENAME "@rx /remote\.php/dav/calendars/[^/]+/inbox$" \
    "id:9508612,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=932236;XML:/*,\
    ctl:ruleRemoveTargetById=942430;XML:/*,\
    ctl:ruleRemoveTargetById=942431;XML:/*,\
    ctl:ruleRemoveTargetById=942432;XML:/*,\
    ctl:ruleRemoveTargetById=932236;XML,\
    ctl:ruleRemoveTargetById=942430;XML,\
    ctl:ruleRemoveTargetById=942431;XML,\
    ctl:ruleRemoveTargetById=942432;XML"

# Personal Settings --> Apperance and accessability --> Navigation bar settings
# Customizing apps load order in the menu
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9.]+\.php/apps/provisioning_api/api/v[0-9.]+/config/users/core/apporder$" \
    "id:9508614,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=932240;ARGS:configValue,\
    ctl:ruleRemoveTargetById=942200;ARGS:configValue,\
    ctl:ruleRemoveTargetById=942430;ARGS:configValue,\
    ctl:ruleRemoveTargetById=942431;ARGS:configValue,\
    ctl:ruleRemoveTargetById=942432;ARGS:configValue,\
    ctl:ruleRemoveTargetById=942340;ARGS:configValue,\
    ctl:ruleRemoveTargetById=942370;ARGS:configValue,\
    ctl:ruleRemoveTargetById=932240;ARGS:json.configValue,\
    ctl:ruleRemoveTargetById=942200;ARGS:json.configValue,\
    ctl:ruleRemoveTargetById=942430;ARGS:json.configValue,\
    ctl:ruleRemoveTargetById=942431;ARGS:json.configValue,\
    ctl:ruleRemoveTargetById=942432;ARGS:json.configValue,\
    ctl:ruleRemoveTargetById=942340;ARGS:json.configValue,\
    ctl:ruleRemoveTargetById=942370;ARGS:json.configValue"

# Validating password against password policy
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9.]+\.php/apps/password_policy/api/v[0-9]/validate$" \
    "id:9508615,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:password,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.password"

# Personal Settings --> Personal Info --> Website
# When adding a link to your own user profile
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9.]+\.php/cloud/users/$" \
    "id:9508618,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=931130;ARGS:value,\
    ctl:ruleRemoveTargetById=931130;ARGS:json.value"

# Personal Settings --> Security --> Basic encryption module
# Updating encryption password used in server side encryption
SecRule REQUEST_FILENAME "@endsWith /apps/encryption/ajax/updatePrivateKeyPassword" \
    "id:9508619,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:newPassword,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:oldPassword"

#
# [ Administration settings ]
#

# Administration Settings --> News --> Explore Service URL
# Configuring an RSS explorer feed
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9.]+\.php/apps/provisioning_api/api/v[0-9.]+/config/apps/news/exploreUrl$" \
    "id:9508640,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=931130;ARGS:json.value,\
    ctl:ruleRemoveTargetById=931130;ARGS:value"

# Administration Settings --> Basic Settings --> Email Server
# Configurating an SMTP server for email notifications
SecRule REQUEST_FILENAME "@endsWith /settings/admin/mailsettings/credentials" \
    "id:9508646,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:mail_smtppassword"

# Administration Settings --> Theming --> Advanced Options
# Adding links for legal notices and privacy policies
SecRule REQUEST_FILENAME "@endsWith /apps/theming/ajax/updateStylesheet" \
    "id:9508648,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=931130;ARGS:value,\
    ctl:ruleRemoveTargetById=931130;ARGS:json.value"

# Administration Settings --> Recognize --> CPU Cores
# Adjusting the amount of cores used for AI facial recognition
# This rule doesn't try to enumerate all endpoints and uses a contains instead, there's simply WAY too many to enumerate.
# If you try, then the regex becomes unreadable and painful to work with.
SecRule REQUEST_FILENAME "@contains /apps/recognize/admin/settings/" \
    "id:9508649,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=932160;ARGS:value,\
    ctl:ruleRemoveTargetById=932160;ARGS:json.value"

# Administration Settings --> Log Reader
# Viewing Nextcloud logs
SecRule REQUEST_FILENAME "@rx /apps/logreader(?:/api)?/poll$" \
    "id:9508652,\
    phase:2,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=932236;ARGS:lastReqId,\
    ctl:ruleRemoveTargetById=942450;ARGS:lastReqId"

# Administration Settings --> Office --> Use your own server
# Configuring WOPI URL for dedicated Collabora Server
SecRule REQUEST_FILENAME "@endsWith /index.php/apps/richdocuments/ajax/admin.php" \
    "id:9508653,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=931130;ARGS:wopi_url,\
    ctl:ruleRemoveTargetById=931130;ARGS:json.wopi_url"

# Administration Settings --> Security --> OAuth 2.0 clients
# Creating/Deleting OAuth 2.0 clients
SecRule REQUEST_FILENAME "@rx /apps/oauth2/clients(?:/[0-9]+)?$" \
    "id:9508655,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=931130;ARGS:redirectUri,\
    ctl:ruleRemoveTargetById=932236;ARGS:name,\
    ctl:ruleRemoveTargetById=931130;ARGS:json.redirectUri,\
    ctl:ruleRemoveTargetById=932236;ARGS:json.name"

#
# [ App Store ]
#

# Loading images/videos for discover page
SecRule REQUEST_FILENAME "@endsWith /settings/api/apps/media" \
    "id:9508670,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=931130;ARGS:fileName"

#
# [ Notifications ]
#

# Sometimes a 502 error is returned when viewing/dismissing a notification
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9.]+\.php/apps/notifications/api/v[0-9]/notifications$" \
    "id:9508702,\
    phase:3,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    chain"
    SecRule RESPONSE_STATUS "@streq 502" \
        "t:none,\
        ctl:ruleRemoveById=950100"

#
# [ Nextcloud Cookbook ]
#

# Creating recipes
# Some rules are disabled for all ARGS since the paramater name keeps on changing
SecRule REQUEST_FILENAME "@rx /apps/cookbook/webapp/recipes(?:/[0-9]+)?$" \
    "id:9508720,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=920273;ARGS_NAMES,\
    ctl:ruleRemoveTargetById=932236;ARGS_NAMES:id,\
    ctl:ruleRemoveTargetById=920272;ARGS,\
    ctl:ruleRemoveTargetById=920273;ARGS,\
    ctl:ruleRemoveTargetById=931130;ARGS,\
    ctl:ruleRemoveTargetById=932200;ARGS,\
    ctl:ruleRemoveTargetById=932236;ARGS,\
    ctl:ruleRemoveTargetById=932380;ARGS,\
    ctl:ruleRemoveTargetById=942200;ARGS,\
    ctl:ruleRemoveTargetById=942210;ARGS,\
    ctl:ruleRemoveTargetById=942430;ARGS,\
    ctl:ruleRemoveTargetById=942431;ARGS,\
    ctl:ruleRemoveTargetById=942432;ARGS,\
    ctl:ruleRemoveTargetById=942460;ARGS,\
    ctl:ruleRemoveTargetById=920272;REQUEST_BODY,\
    ctl:ruleRemoveTargetById=920273;REQUEST_BODY"

# Importing cookbooks from a URL
SecRule REQUEST_FILENAME "@endsWith /apps/cookbook/webapp/import" \
    "id:9508723,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=931130;ARGS:url"

#
# [ API ]
#

# Allow access to the shares API URL from mobile app
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9.]+\.php/apps/files_sharing/api/v1/shares" \
    "id:9508800,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    chain"
    SecRule REQUEST_METHOD "@streq GET" \
        "t:none,\
        ctl:ruleRemoveById=200002"

#
# [ Nextcloud Deck ]
#

# When updating a card
# Moving a card in deck
# Unassigning a user from a card
# Setting a due date on a card
SecRule REQUEST_FILENAME "@rx /apps/deck/cards(?:/[0-9]+(?:/reorder|/unassign)?)?$" \
    "id:9508810,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:description,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.description"

#
# [ Dashboard ]
#

# Enabling/disabling weather/status widgets in dashboard
SecRule REQUEST_FILENAME "@endsWith /apps/dashboard/statuses" \
    "id:9508830,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=932240;ARGS:json.statuses,\
    ctl:ruleRemoveTargetById=942260;ARGS:json.statuses,\
    ctl:ruleRemoveTargetById=942431;ARGS:json.statuses,\
    ctl:ruleRemoveTargetById=942432;ARGS:json.statuses,\
    ctl:ruleRemoveTargetById=932240;ARGS:statuses,\
    ctl:ruleRemoveTargetById=942260;ARGS:statuses,\
    ctl:ruleRemoveTargetById=942431;ARGS:statuses,\
    ctl:ruleRemoveTargetById=942432;ARGS:statuses"

#
# [ Nextcloud News ]
#

# Subscribing to an RSS feed
# Subscribing to an RSS feed with a password
SecRule REQUEST_FILENAME "@rx ^/(?:index\.php/apps/news/api/v[0-9.-]+|apps/news)/feeds$" \
    "id:9508840,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=920230;ARGS:json.url,\
    ctl:ruleRemoveTargetById=920272;ARGS:json.url,\
    ctl:ruleRemoveTargetById=920273;ARGS:json.url,\
    ctl:ruleRemoveTargetById=931130;ARGS:json.url,\
    ctl:ruleRemoveTargetById=932200;ARGS:json.url,\
    ctl:ruleRemoveTargetById=932380;ARGS:json.url,\
    ctl:ruleRemoveTargetById=942430;ARGS:json.url,\
    ctl:ruleRemoveTargetById=942431;ARGS:json.url,\
    ctl:ruleRemoveTargetById=942432;ARGS:json.url,\
    ctl:ruleRemoveTargetById=920230;ARGS:url,\
    ctl:ruleRemoveTargetById=920272;ARGS:url,\
    ctl:ruleRemoveTargetById=920273;ARGS:url,\
    ctl:ruleRemoveTargetById=931130;ARGS:url,\
    ctl:ruleRemoveTargetById=932200;ARGS:url,\
    ctl:ruleRemoveTargetById=932380;ARGS:url,\
    ctl:ruleRemoveTargetById=942430;ARGS:url,\
    ctl:ruleRemoveTargetById=942431;ARGS:url,\
    ctl:ruleRemoveTargetById=942432;ARGS:url,\
    ctl:ruleRemoveTargetById=920273;REQUEST_BODY,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.password,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:password"

#
# [ Smart Picker ]
#

# Adding/Displaying hyperlinks
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9.]+\.php/references/resolve(?:Public)?$" \
    "id:9508880,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=920230;ARGS:reference,\
    ctl:ruleRemoveTargetById=931130;ARGS:reference,\
    ctl:ruleRemoveTargetById=932200;ARGS:reference,\
    ctl:ruleRemoveTargetById=942430;ARGS:reference,\
    ctl:ruleRemoveTargetById=942431;ARGS:reference,\
    ctl:ruleRemoveTargetById=942432;ARGS:reference,\
    ctl:ruleRemoveTargetById=921151;ARGS_GET:reference"

#
# [ Extensions ]
#

# Extension: Ransomware protection

# Allow configure file extensions fields
SecRule REQUEST_FILENAME "@contains /config/apps/ransomware_protection/extension_additions" \
    "id:9508900,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=932130;ARGS:value"

#
# [ Nextcloud Notes ]
#

# Note name and content can be anything
SecRule REQUEST_FILENAME "@rx /index\.php/apps/notes/api/v[0-9]/notes(?:/[0-9]+)?$" \
    "id:9508910,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:content,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:title,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.content,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.title"

# Note name and content can be anything
SecRule REQUEST_FILENAME "@rx /apps/notes/notes/[0-9]+(?:/autotitle)?$" \
    "id:9508920,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:content,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:title,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.content,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.title"

#
# [ Custom CSS ]
#

# Allow admin to add custom CSS code
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9.]+\.php/apps/provisioning_api/api/v[0-9]/config/apps/theming_customcss/customcss$" \
    "id:9508930,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:value"

#
# [ Nextcloud Teams (Formerly Circles) ]
#

# When setting a unique password for all shares to a circle
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9.]+\.php/apps/circles/circles/[^/]+/setting$" \
    "id:9508941,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:value,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.value"

#
# [ Nextcloud Photos ]
#

# Loading image preview in Nextcloud Photos
SecRule REQUEST_FILENAME "@rx /apps/photos/api/v[0-9.]+/preview/[0-9]+$" \
    "id:9508951,\
    phase:3,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    chain"
    SecRule RESPONSE_STATUS "@streq 500" \
        "t:none,\
        ctl:ruleRemoveById=950100"

# Photos: Albums, Shared Albums, Places
SecRule REQUEST_FILENAME "@rx /remote\.php/dav/photos/[^/]+/(?:albums|sharedalbums|places)(?:/[^/]+)?/?$" \
    "id:9508952,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=921110;REQUEST_BODY"

# Sorting photos based upon faces in Nextcloud Photos
SecRule REQUEST_FILENAME "@rx /remote\.php/dav/recognize/[^/]+/faces/(?:[^/]+/)?$" \
    "id:9508953,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=921110;REQUEST_BODY"

# Configuring folders for Nextcloud Photos to scan
# Configuring "Upload folder" location
SecRule REQUEST_FILENAME "@rx /apps/photos/api/v[0-9.]+/config/(?:photosLocation|photosSourceFolders)$" \
    "id:9508957,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=942100;ARGS:json.value,\
    ctl:ruleRemoveTargetById=942200;ARGS:json.value,\
    ctl:ruleRemoveTargetById=942370;ARGS:json.value,\
    ctl:ruleRemoveTargetById=942520;ARGS:json.value,\
    ctl:ruleRemoveTargetById=942100;ARGS:value,\
    ctl:ruleRemoveTargetById=942200;ARGS:value,\
    ctl:ruleRemoveTargetById=942370;ARGS:value,\
    ctl:ruleRemoveTargetById=942520;ARGS:value"

#
# [ Nextcloud Mail ]
#

# Some email addresses end in .com or .inc
# Obtaining configuration for an email address
SecRule REQUEST_FILENAME "@rx /apps/mail/api/autoconfig/(?:ispdb|mx)/(?:[^/]+/)?[^/]+\.(?:com|inc)$" \
    "id:9508970,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveById=920440"

# Loading a mailbox avatar from an email address ending in com or inc
SecRule REQUEST_FILENAME "@rx /apps/mail/api/avatars/(?:url|image)/[^/]+\.(?:com|inc)$" \
    "id:9508971,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveById=920440"

# When logging into an email account
SecRule REQUEST_FILENAME "@endsWith /apps/mail/api/accounts" \
    "id:9508972,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:imapPassword,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:smtpPassword,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.imapPassword,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.smtpPassword"

# Loading images in an email message from remote location
SecRule REQUEST_FILENAME "@endsWith /apps/mail/proxy" \
    "id:9508973,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=920230;ARGS:src,\
    ctl:ruleRemoveTargetById=920273;ARGS:src,\
    ctl:ruleRemoveTargetById=931130;ARGS:src,\
    ctl:ruleRemoveTargetById=932200;ARGS:src,\
    ctl:ruleRemoveTargetById=942120;ARGS:src,\
    ctl:ruleRemoveTargetById=942421;ARGS:src,\
    ctl:ruleRemoveTargetById=942430;ARGS:src,\
    ctl:ruleRemoveTargetById=942431;ARGS:src,\
    ctl:ruleRemoveTargetById=942432;ARGS:src"

# Writing a draft email
SecRule REQUEST_FILENAME "@rx /apps/mail/api/accounts/[0-9]+/draft$" \
    "id:9508976,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:editorBody,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:body,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.editorBody,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.body"

# Sending an email
SecRule REQUEST_FILENAME "@rx /apps/mail/api/outbox(?:/[0-9]+)?$" \
    "id:9508977,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:editorBody,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:body,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.editorBody,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.body"

# Assigning/removing flags for emails
# Marking an email as junk/not-junk
SecRule REQUEST_FILENAME "@rx /apps/mail/api/messages/[0-9]+/flags$" \
    "id:9508978,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=942290;ARGS_NAMES:flags.$notjunk,\
    ctl:ruleRemoveTargetById=942290;ARGS_NAMES:json.flags.$notjunk"

# When clicking on an email address within Nextcloud Mail
SecRule REQUEST_FILENAME "@rx /apps/mail/api/contactIntegration/match/[^/]+\.(?:com|inc)$" \
    "id:9508979,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveById=920440"

# Changing Nextcloud Mail Settings
# Sorting email from oldest/newest
# Adjusting placement of reply (top / bottom)
# Enabling/disabling external avatars from Gravatar
# Enabling/disabling search for message body within priority inbox
# Adjusting the layout of Nextcloud Mail
# Adjusting size of email message compose box
# Enabling/disabling internal addresses
SecRule REQUEST_FILENAME "@rx /apps/mail/api/preferences/(?:account-settings|collect-data|external-avatars|internal-addresses|layout-mode|modalSize|reply-a?mode|search-priority-body|sort-order|start-mailbox-id|tag-classified-messages)$" \
    "id:9508981,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=920273;ARGS:value,\
    ctl:ruleRemoveTargetById=932236;ARGS:value,\
    ctl:ruleRemoveTargetById=942200;ARGS:value,\
    ctl:ruleRemoveTargetById=942260;ARGS:value,\
    ctl:ruleRemoveTargetById=942421;ARGS:value,\
    ctl:ruleRemoveTargetById=942430;ARGS:value,\
    ctl:ruleRemoveTargetById=942431;ARGS:value,\
    ctl:ruleRemoveTargetById=942432;ARGS:value,\
    ctl:ruleRemoveTargetById=920273;ARGS:json.value,\
    ctl:ruleRemoveTargetById=932236;ARGS:json.value,\
    ctl:ruleRemoveTargetById=942200;ARGS:json.value,\
    ctl:ruleRemoveTargetById=942260;ARGS:json.value,\
    ctl:ruleRemoveTargetById=942421;ARGS:json.value,\
    ctl:ruleRemoveTargetById=942430;ARGS:json.value,\
    ctl:ruleRemoveTargetById=942431;ARGS:json.value,\
    ctl:ruleRemoveTargetById=942432;ARGS:json.value"

# When configuring mail account provisioning
SecRule REQUEST_FILENAME "@rx /apps/mail/api/settings/provisioning(?:/[0-9]+)?$" \
    "id:9508982,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetById=920230;ARGS:data.sieveUser,\
    ctl:ruleRemoveTargetById=920230;ARGS:data.imapUser,\
    ctl:ruleRemoveTargetById=920230;ARGS:data.smtpUser,\
    ctl:ruleRemoveTargetById=920230;ARGS:data.emailTemplate,\
    ctl:ruleRemoveTargetById=920230;ARGS:json.data.sieveUser,\
    ctl:ruleRemoveTargetById=920230;ARGS:json.data.imapUser,\
    ctl:ruleRemoveTargetById=920230;ARGS:json.data.smtpUser,\
    ctl:ruleRemoveTargetById=920230;ARGS:json.data.emailTemplate"

# Enabling/Disabling sieve filters under Nextcloud Mail --> Account settings --> Sieve Filter
# Allow setting custom password for sieve filter
SecRule REQUEST_FILENAME "@rx /apps/mail/api/sieve/account/[0-9]+$" \
    "id:9508986,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:sievePassword,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.sievePassword"

# Adding/Removing trusted sender domains with com or inc TLD
# Adding/Removing internal addresses domains with com or inc TLD
SecRule REQUEST_FILENAME "@rx /apps/mail/api/(?:internalAddress|trustedsenders)/[^/]+\.(?:com|inc)$" \
    "id:9508988,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveById=920440"

# When creating an email signature for Nextcloud Mail
SecRule REQUEST_FILENAME "@rx /apps/mail/api/accounts/[0-9]+(?:/aliases/[0-9]+)?/signature$" \
    "id:9508989,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.signature,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:signature"

# Writing an draft email
# Email subject/body could be anything
SecRule REQUEST_FILENAME "@rx /apps/mail/api/drafts(?:/[0-9]+|/\{id\})?$" \
    "id:9508991,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:body,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:data.body.value,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:data.editorBody,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:editorBody,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:subject,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.body,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.data.body.value,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.data.editorBody,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.editorBody,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.subject"

# Sending an email
# Editing an email from outbox
# Email subject/body could be anything
SecRule REQUEST_FILENAME "@rx /apps/mail/api/outbox/(?:from-draft/)?[0-9]+$" \
    "id:9508992,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.3.1',\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:body,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:editorBody,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:subject,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.body,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.editorBody,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.subject"
