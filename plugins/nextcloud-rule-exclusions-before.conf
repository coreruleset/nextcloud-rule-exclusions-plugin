# ------------------------------------------------------------------------
# OWASP ModSecurity Core Rule Set Plugin
# Copyright (c) 2021-2022 Core Rule Set project. All rights reserved.
#
# The OWASP ModSecurity Core Rule Set plugins are distributed under
# Apache Software License (ASL) version 2
# Please see the enclosed LICENSE file for full details.
# ------------------------------------------------------------------------

# OWASP CRS Plugin
# Plugin name: nextcloud-rule-exclusions
# Plugin description:
# Rule ID block base: 9,508,000 - 9,508,999
# Plugin version: 1.0.0

# Documentation can be found here:
# https://github.com/coreruleset/nextcloud-rule-exclusions-plugin

# Generic rule to disable plugin
SecRule TX:nextcloud-rule-exclusions-plugin_enabled "@eq 0" "id:9508099,phase:1,pass,nolog,ctl:ruleRemoveById=9508100-9508999"


# These exclusions remedy false positives in a default Nextcloud install.
# They will likely work with OwnCloud too, but you may have to modify them.
#
# To relax upload restrictions for only the php files that need it,
# you put something like this in crs-setup.conf:
#
# SecRule REQUEST_FILENAME "@rx /(?:remote.php|index.php)/" \
#   "id:9508600,\
#   phase:2,\
#   t:none,\
#   nolog,\
#   pass,\
#   setvar:'tx.restricted_extensions=.bak/ .config/ .conf/'"
#
# Large uploads can be modified with SecRequestBodyLimit. Or they
# can be more controlled by using the following:
#
# SecRule REQUEST_URI "@endsWith /index.php/apps/files/ajax/upload.php" \
#    "id:9508610,\
#    phase:1,\
#    t:none,\
#    nolog,\
#    ctl:requestBodyLimit=1073741824"
#
# Please note, that `ctl:requestBodyLimit` action does not work
# in libmodsecurity3!


#
# [ Local CRS initialization ]
#
# We need to initialize some of the CRS variables also here because plugin setup runs before
# CRS initialization (this is a known limitation of the current plugin architecture). Must be
# kept in sync with CRS default setting.


# Copy of CRS rule 901160.
SecRule &TX:allowed_methods "@eq 0" \
    "id:9508100,\
    phase:1,\
    pass,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=GET HEAD POST OPTIONS'"


# Copy of CRS rule 901162.
SecRule &TX:allowed_request_content_type "@eq 0" \
    "id:9508101,\
    phase:1,\
    pass,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_request_content_type=|application/x-www-form-urlencoded| |multipart/form-data| |multipart/related| |text/xml| |application/xml| |application/soap+xml| |application/json| |application/cloudevents+json| |application/cloudevents-batch+json|'"


#
# [ File Manager ]
#

# The web interface uploads files, and interacts with the user.
SecRule REQUEST_FILENAME "@contains /remote.php/webdav" \
    "id:9508102,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveByTag=attack-injection-php,\
    ctl:ruleRemoveById=941000-942999,\
    ctl:ruleRemoveById=951000-951999,\
    ctl:ruleRemoveById=953100-953130,\
    ctl:ruleRemoveById=920420,\
    ctl:ruleRemoveById=920440,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0'"

# Skip PUT parsing for invalid encoding / protocol violations in binary files.
SecRule REQUEST_METHOD "@streq PUT" \
    "id:9508105,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    chain"
    SecRule REQUEST_FILENAME "@rx /remote\.php/(?:webdav|dav)" \
        "t:none,\
        ctl:ruleRemoveById=920000-920999,\
        ctl:ruleRemoveById=932000-932999,\
        ctl:ruleRemoveById=921150,\
        ctl:ruleRemoveById=930110,\
        ctl:ruleRemoveById=930120"

# Fix for Nextcloud Desktop Client / Allow sending source code
SecRule REQUEST_METHOD "@pm PROPFIND PUT" \
    "id:9508106,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    chain"
    SecRule REQUEST_FILENAME "@rx /remote\.php/(?:webdav|dav/files)" \
        "t:none,\
        ctl:ruleRemoveById=921110"

# Allow the data type 'text/vcard'
SecRule REQUEST_FILENAME "@contains /remote.php/dav/files/" \
    "id:9508110,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_request_content_type=%{tx.allowed_request_content_type} |text/plain| |text/vcard|'"

# Allow the data type 'application/octet-stream'
SecRule REQUEST_METHOD "@pm PUT MOVE" \
    "id:9508115,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    chain"
    SecRule REQUEST_FILENAME "@rx /remote\.php/dav/(?:files|uploads)/" \
        "setvar:'tx.allowed_request_content_type=%{tx.allowed_request_content_type} |application/octet-stream| |application/pdf|'"

# Allow data types like video/mp4
SecRule REQUEST_METHOD "@streq PUT" \
    "id:9508116,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    chain"
    SecRule REQUEST_FILENAME "@rx /(?:public\.php/webdav|remote\.php/dav/uploads)/" \
        "ctl:ruleRemoveById=920340,\
        ctl:ruleRemoveById=920420"

# Allow characters like /../ in files.
# Allow all kind of filetypes.
# Allow source code.
SecRule REQUEST_FILENAME "@contains /remote.php/dav/files/" \
    "id:9508120,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveById=930100-930110,\
    ctl:ruleRemoveById=951000-951999,\
    ctl:ruleRemoveById=953100-953130,\
    ctl:ruleRemoveById=920440,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0'"

# Allow REPORT requests without Content-Type header (at least the iOS app does this)
SecRule REQUEST_METHOD "@streq REPORT" \
    "id:9508121,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    chain"
    SecRule REQUEST_FILENAME "@contains /remote.php/dav/files/" \
        "t:none,\
        ctl:ruleRemoveById=920340"

# FP when NextCloud default app "Text" detects text files in file manager.
# PUT - When the "Text" app tries to create a session in file manager.
SecRule REQUEST_FILENAME "@contains /apps/text/session/create" \
    "id:9508122,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT'"

# FP while trying to open text files in file manager
SecRule REQUEST_FILENAME "@contains /remote.php/dav/comments" \
    "id:9508123,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_request_content_type=%{tx.allowed_request_content_type} |text/plain|'"

# When trying to change the "Show recommendations" option in file settings
SecRule REQUEST_FILENAME "@contains /apps/recommendations/settings/enabled" \
    "id:9508124,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT'"

# Text app autosave sync feature doesn't work
# ARGS:json.documentState FP was introduced in Nextcloud 26, it's triggered when selecting different note entries.
SecRule REQUEST_URI "@contains /apps/text/session/sync" \
    "id:9508126,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetById=941100;ARGS:json.documentState,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:autosaveContent,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0'"

# Text app content can be anything
SecRule REQUEST_FILENAME "@endsWith /apps/text/public/session/sync" \
    "id:9508127,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.autosaveContent,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0'"

# Text app content can be anything
SecRule REQUEST_FILENAME "@endsWith /apps/text/public/session/push" \
    "id:9508128,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0'"

# Text app content can be anything
SecRule REQUEST_FILENAME "@endsWith /apps/text/session/push" \
    "id:9508129,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0'"

#
# [ Searchengine ]
#

# Nextcloud uses a search field for filename or content queries.
SecRule REQUEST_FILENAME "@contains /index.php/core/search" \
    "id:9508125,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetByTag=attack-injection-php;ARGS:query,\
    ctl:ruleRemoveTargetById=941000-942999;ARGS:query,\
    ctl:ruleRemoveTargetById=932000-932999;ARGS:query,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0'"


#
# [ DAV ]
#

# Nextcloud uses DAV methods with index.php and remote.php to do many things
# The default ones in ModSecurity are: GET HEAD POST OPTIONS
#
# Looking through the code, and via testing, I found these:
#
# File manager: PUT DELETE MOVE PROPFIND PROPPATCH
# Calendars: REPORT
# Others in the code or js files: PATCH MKCOL MOVE TRACE
# Others that I added just in case, and they seem related:
#   CHECKOUT COPY LOCK MERGE MKACTIVITY UNLOCK.
SecRule REQUEST_FILENAME "@rx /(?:remote|index|public)\.php/" \
    "id:9508130,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT PATCH CHECKOUT COPY DELETE LOCK MERGE MKACTIVITY MKCOL MOVE PROPFIND PROPPATCH SEARCH UNLOCK REPORT TRACE jsonp'"

# We need to allow DAV methods for sharing files, and removing shares
# DELETE - when the share is removed
# PUT - when setting a password / expiration time
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9]+\.php/apps/files_sharing/" \
    "id:9508140,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT DELETE'"


#
# [ Preview and Thumbnails ]
#

# Preview
SecRule REQUEST_FILENAME "@contains /index.php/core/preview.png" \
    "id:9508150,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetById=932150;ARGS:file,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0'"

# Filepreview for trashbin
SecRule REQUEST_FILENAME "@contains /index.php/apps/files_trashbin/ajax/preview.php" \
    "id:9508155,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetById=932150;ARGS:file,\
    ctl:ruleRemoveTargetById=942190;ARGS:file,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0'"

# Thumbnails
SecRule REQUEST_FILENAME "@contains /index.php/apps/gallery/thumbnails" \
    "id:9508160,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetById=941120;ARGS:requesttoken,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0'"


#
# [ Ownnote ]
#

SecRule REQUEST_FILENAME "@contains /index.php/apps/ownnote/" \
    "id:9508300,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveById=941150,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0'"


#
# [ Text Editor ]
#

# This file can save anything, and it's name could be lots of things.
SecRule REQUEST_FILENAME "@contains /index.php/apps/files_texteditor/" \
    "id:9508310,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:filecontents,\
    ctl:ruleRemoveTargetById=921110-921160;ARGS:filecontents,\
    ctl:ruleRemoveTargetById=932150;ARGS:filename,\
    ctl:ruleRemoveTargetById=920370-920390;ARGS:filecontents,\
    ctl:ruleRemoveTargetById=920370-920390;ARGS_COMBINED_SIZE,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0'"


#
# [ Address Book ]
#

# Allow the data type 'text/vcard'
SecRule REQUEST_FILENAME "@contains /remote.php/dav/addressbooks/" \
    "id:9508320,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_request_content_type=%{tx.allowed_request_content_type} |text/vcard|'"

# Allow modifying contacts via the web interface
SecRule REQUEST_METHOD "@streq PUT" \
    "id:9508321,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    chain"
    SecRule REQUEST_FILENAME "@contains /remote.php/dav/addressbooks/" \
        "t:none,\
        ctl:ruleRemoveById=200002"

# When enabling "Update avatar from social media" setting in Nextcloud Contacts
SecRule REQUEST_FILENAME "@rx /apps/contacts/api/v[0-9]/social/config/user/enableSocialSync$" \
    "id:9508322,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT'"

#
# [ Calendar ]
#

# Allow the data type 'text/calendar'
SecRule REQUEST_FILENAME "@contains /remote.php/dav/calendars/" \
    "id:9508330,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_request_content_type=%{tx.allowed_request_content_type} |text/calendar| |text/plain|'"

# Allow modifying calendar events via the web interface
SecRule REQUEST_METHOD "@streq PUT" \
    "id:9508331,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    chain"
    SecRule REQUEST_FILENAME "@contains /remote.php/dav/calendars/" \
        "t:none,\
        ctl:ruleRemoveById=200002"

# Fix for iOS Calender not syncing
SecRule REQUEST_METHOD "@streq PROPFIND" \
    "id:9508332,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    chain"
    SecRule REQUEST_FILENAME "@rx /remote\.php/dav/(?:principals/users|calendars)/" \
        "t:none,\
        ctl:ruleRemoveById=921110"


#
# [ Notes ]
#

# We want to allow a lot of things as the user is
# allowed to note on anything.
SecRule REQUEST_FILENAME "@contains /index.php/apps/notes/" \
    "id:9508340,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveByTag=attack-injection-php,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0'"


#
# [ Bookmarks ]
#

# Allow urls in data.
SecRule REQUEST_FILENAME "@contains /index.php/apps/bookmarks/" \
    "id:9508350,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveById=931130,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0'"


#
# [ Login forms and Logout ]
#
# This removes checks on the 'password' and related fields:

# User login password.
SecRule REQUEST_FILENAME "@endsWith /login" \
    "id:9508400,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetById=941100;ARGS:requesttoken,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:password,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0'"

# Reset password.
SecRule REQUEST_FILENAME "@endsWith /login" \
    "id:9508410,\
    phase:2,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    chain"
    SecRule ARGS:action "@streq resetpass" \
        "t:none,\
        chain"
        SecRule &ARGS:action "@eq 1" \
            "t:none,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:pass1,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:pass1-text,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:pass2"

# Logout token
SecRule REQUEST_FILENAME "@endsWith /logout" \
    "id:9508420,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetById=941120;ARGS:requesttoken,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0'"

# Change Password and Setting up a new user/password
SecRule REQUEST_FILENAME "@endsWith /settings/users" \
    "id:9508500,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:newuserpassword,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:password,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0'"


#
# [ Settings pages ]
#
# This removes checks on multiple settings pages

# Personal: Security

# Fixes deletion and allow/disallow of filesystem access for auth tokens
SecRule REQUEST_FILENAME "@contains /settings/personal/authtokens/" \
    "id:9508601,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT DELETE'"

# When trying to remove a WebAuthn device
SecRule REQUEST_FILENAME "@contains /settings/api/personal/webauthn/registration" \
    "id:9508606,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} DELETE'"

# While going through the first run setup wizard
SecRule REQUEST_FILENAME "@contains /apps/firstrunwizard/wizard" \
    "id:9508607,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} DELETE'"

# When trying to update Personal --> Sharing --> Sharing --> Accept user and groups shares by default
SecRule REQUEST_FILENAME "@rx /apps/files_sharing/settings/(?:defaultAccept|shareFolder)$" \
    "id:9508608,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT DELETE'"

# When trying to delete profile picture in Personal --> Personal info
SecRule REQUEST_FILENAME "@endsWith /avatar" \
    "id:9508611,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} DELETE'"

# When trying to delete users with data access(Personal --> Privacy --> Who has access to your data?)
SecRule REQUEST_FILENAME "@contains /apps/privacy/api/admins" \
    "id:9508614,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} DELETE'"

# Personal --> Availability
# When trying to "Automatically set user status to Do no disturb"
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9]+\.php/apps/provisioning_api/api/v[0-9]+/config/users/dav/user_status_automation" \
    "id:9508615,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} DELETE'"


# Administration: Overview

# Fixed "Security & setup warnings" test
SecRule REQUEST_FILENAME "@contains /.well-known/caldav" \
    "id:9508602,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PROPFIND'"

SecRule REQUEST_FILENAME "@contains /.well-known/carddav" \
    "id:9508603,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PROPFIND'"

# Administration --> Sharing --> Federated cloud sharing
# When trying to delete a trusted server
SecRule REQUEST_FILENAME "@contains /apps/federation/trusted-servers/" \
    "id:9508609,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} DELETE'"

# When trying to change cron method in Administration --> Basic settings --> Background jobs
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9]+\.php/apps/provisioning_api/api/v[0-9]+/config/apps/core/cronErrors" \
    "id:9508612,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} DELETE'"

# When trying to enforce Two-Factor Authentication for a group(Administration --> Security --> Two-Factor Authentication)
SecRule REQUEST_FILENAME "@contains /settings/api/admin/twofactorauth" \
    "id:9508613,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT'"

# When trying to change log levels and live update in (Administration --> Logging)
SecRule REQUEST_FILENAME "@rx /apps/logreader/(?:live|levels)" \
    "id:9508610,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT'"

# Appearance and accessibility

# Enabling any default theme requires the PUT method.
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9]+\.php/apps/theming/api/v[0-9]+/theme/.*?/enable" \
    "id:9508604,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT'"

# When trying to enable keyboard shortcuts
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9]+\.php/apps/provisioning_api/api/v[0-9]+/config/users/theming/shortcuts_disabled" \
    "id:9508605,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} DELETE'"

# Deleting an avatar
SecRule REQUEST_FILENAME "@endsWith /avatar" \
    "id:9508616,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} DELETE'"

# Disabling background
SecRule REQUEST_FILENAME "@endsWith /apps/theming/background/custom" \
    "id:9508617,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} DELETE'"

# When deleting an admin from privacy page
SecRule REQUEST_FILENAME "@rx /apps/privacy/api/admins/[0-9]*$" \
    "id:9508618,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} DELETE'"

# When disabling settings under Settings --> Availability
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9]\.php/apps/provisioning_api/api/v[0-9]/config/users/dav/user_status_automation$" \
    "id:9508619,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} DELETE'"

# When configurating an SMTP server under Administration --> Basic Settings --> Email Server
SecRule REQUEST_FILENAME "@endsWith /settings/admin/mailsettings/credentials" \
    "id:9508620,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:mail_smtppassword,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0'"

# When removing whitelisted IPs under Administration --> Security --> Brute Force IP whitelsit
SecRule REQUEST_FILENAME "@rx /apps/bruteforcesettings/ipwhitelist/[0-9]*$" \
    "id:9508621,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} DELETE'"

# When adding legal notices and privacy policy under Administration --> Theming --> Advanced Options
SecRule REQUEST_FILENAME "@endsWith /apps/theming/ajax/updateStylesheet" \
    "id:9508622,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetById=931130;ARGS:json.value,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0'"

#
# [ Notifications ]
#
# Nextcloud uses notifictions to inform the user of important new details.

# Allows notifications to be deleted
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9]+\.php/apps/notifications/api/v2/notifications" \
    "id:9508701,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} DELETE'"


#
# [ API ]
#

# Allow access to the shares API URL from mobile app
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9]+\.php/apps/files_sharing/api/v1/shares" \
    "id:9508800,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    chain"
    SecRule REQUEST_METHOD "@streq GET" \
        "t:none,\
        ctl:ruleRemoveById=200002"

# NextCloud session keep-alive functionality sends a "heartbeat" to the server to keep it from timing out.
# This is enabled by default whenever a user is logged in to NextCloud Web UI.
# https://docs.nextcloud.com/server/latest/admin_manual/configuration_server/config_sample_php_parameters.html#user-experience
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9]+\.php/apps/user_status/api/v[0-9]+/heartbeat" \
    "id:9508801,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT'"

# while trying to update the Weather location, mode or add favorites
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9]+\.php/apps/weather_status/api/v[0-9]+" \
    "id:9508802,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT'"

# When trying to update user status or status message
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9]+\.php/apps/user_status/api/v[0-9]+/user_status" \
    "id:9508803,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT DELETE'"


#
# [ Users ]
#

# Allow users to be deleted and user profile settings to be updated
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9]+\.php/cloud/users/" \
    "id:9508850,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT DELETE'"

# Allow users Profile visibility settings to be updated in Personal info
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9]+\.php/profile" \
    "id:9508851,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT'"


# [ Survey Client ]
#

# When trying to reject metrics sharing
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9]+\.php/apps/survey_client/api" \
    "id:9508860,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} DELETE'"

#
# [ Mobile App ]
#

# When trying to remove account from Mobile App
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9]+\.php/core/apppassword" \
    "id:9508870,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} DELETE'"

#
# [ Extensions ]
#

# Extension: Ransomware protection

# Allow configure file extensions fields
SecRule REQUEST_FILENAME "@contains /config/apps/ransomware_protection/extension_additions" \
    "id:9508900,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetById=932130;ARGS:value,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0'"

#
# [ Nextcloud Notes ]
#

# Note name and content can be anything
SecRule REQUEST_FILENAME "@rx /index\.php/apps/notes/api/v[0-9]/notes" \
    "id:9508910,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.content,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.title,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0'"

# Note name and content can be anything
# PUT - when making changes/creating notes
# DELETE - when notes are deleted
SecRule REQUEST_FILENAME "@contains /apps/notes/notes/" \
    "id:9508920,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.content,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.title,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT DELETE'"

# When changing settings within Nextcloud Notes
SecRule REQUEST_FILENAME "@endsWith /apps/notes/settings" \
    "id:9508921,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT'"

#
# [ Custom CSS ]
#

# Allow admin to add custom CSS code
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9]\.php/apps/provisioning_api/api/v[0-9]/config/apps/theming_customcss/customcss$" \
    "id:9508930,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:value,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0'"

#
# [ Nextcloud Circles ]
#

# When using Nextcloud circles
# PUT - When editing/creating a circle
# DELETE - When deleting an existing circle
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9]\.php/apps/circles/circles/" \
    "id:9508940,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT DELETE'"

# When setting a unique password for all shares to a circle
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9]\.php/apps/circles/circles/.*/setting$" \
    "id:9508941,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.value,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0'"

#
# [ Nextcloud Photos ]
#

# When changing settings for Nextcloud photos
SecRule REQUEST_FILENAME "@rx /apps/photos/api/v[0-9]/config/config/(?:croppedLayout|photosLocation)$" \
    "id:9508950,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT'"

#
# [ Nextcloud Files ]
#

# Expanding share menus under Files --> Shares
SecRule REQUEST_FILENAME "@rx /apps/files/api/v[0-9]/views/shareoverview/expanded$" \
    "id:9508960,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT'"

# Changing settings within Nextcloud Files
SecRule REQUEST_FILENAME "@rx /apps/files/api/v[0-9]/config/(?:show_hidden|crop_image_previews)$" \
    "id:9508961,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT'"

# Changing sorting direction in trashbin
SecRule REQUEST_FILENAME "@rx /apps/files/api/v[0-9]/views/trashbin/(?:sorting_direction|sorting_mode)$" \
    "id:9508962,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} PUT'"

# Rejecting a file ownership transfer
SecRule REQUEST_FILENAME "@rx /ocs/v[0-9]\.php/apps/files/api/v[0-9]/transferownership/[0-9]*$" \
    "id:9508963,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ver:'nextcloud-rule-exclusions-plugin/1.0.0',\
    setvar:'tx.allowed_methods=%{tx.allowed_methods} DELETE'"

SecMarker "END-NEXTCLOUD-ADMIN"
